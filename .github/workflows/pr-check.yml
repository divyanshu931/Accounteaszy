name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Initialize Failure Flag
        run: echo "FAIL=0" >> $GITHUB_ENV

      # 1ï¸âƒ£ Branch Name Check
      - name: Validate Branch Name
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" != "development" && ! "$BRANCH_NAME" =~ ^[a-zA-Z0-9]+_.*$ ]]; then
            echo "âŒ Invalid branch name"
            echo "FAIL=1" >> $GITHUB_ENV
          fi

      # 2ï¸âƒ£ PR Title Check
      - name: Validate PR Title
        continue-on-error: true
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: '$TITLE'"

          if [[ "$TITLE" =~ ^(feat|fix|chore|docs|refactor|test):[[:space:]].+ ]]; then
            echo "âœ… PR title format valid"
          else
            echo "âŒ Invalid PR title format"
            echo ""
            echo "Expected format:"
            echo "  feat: description"
            echo "  fix: description"
            echo "  chore: description"
            echo ""
            echo "Rules:"
            echo "- Must start with lowercase keyword"
            echo "- Must contain colon"
            echo "- Must have a space after colon"
            echo ""
            echo "Example:"
            echo "  chore: add proper gitignore"
            echo "FAIL=1" >> $GITHUB_ENV
          fi

      # 3ï¸âƒ£ Secret & URL Scan
      - name: Scan for Secrets & URLs
        continue-on-error: true
        run: |
          if grep -R -E "(API_KEY|SECRET_KEY|PASSWORD|TOKEN)" .; then
            echo "âŒ Secret detected"
            echo "FAIL=1" >> $GITHUB_ENV
          fi

          if grep -R -E "http://|https://" .; then
            echo "âŒ Hardcoded URL detected"
            echo "FAIL=1" >> $GITHUB_ENV
          fi

      # 4ï¸âƒ£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 5ï¸âƒ£ Install Dependencies
      - name: Install Dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install flake8 black

      # 6ï¸âƒ£ Lint
      - name: Run Flake8
        continue-on-error: true
        run: |
          if ! flake8 .; then
            echo "FAIL=1" >> $GITHUB_ENV
          fi

      # 7ï¸âƒ£ Format Check
      - name: Black Check
        continue-on-error: true
        run: |
          if ! black --check .; then
            echo "FAIL=1" >> $GITHUB_ENV
          fi

      # 8ï¸âƒ£ Django Check
      - name: Django Check
        continue-on-error: true
        run: |
          if [ -f manage.py ]; then
            if ! python manage.py check; then
              echo "FAIL=1" >> $GITHUB_ENV
            fi
          fi

      # 9ï¸âƒ£ Run Tests
      - name: Run Tests
        continue-on-error: true
        run: |
          if [ -f manage.py ]; then
            if ! python manage.py test; then
              echo "FAIL=1" >> $GITHUB_ENV
            fi
          fi

      # ğŸ”Ÿ Final Result
      - name: Final Validation Result
        run: |
          if [[ "$FAIL" == "1" ]]; then
            echo "âŒ One or more checks failed"
            exit 1
          else
            echo "âœ… All checks passed"
          fi